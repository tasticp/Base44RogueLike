name: Deploy Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
          - development
      force_deploy:
        description: 'Force deploy even if tests fail'
        required: false
        default: false
        type: boolean

env:
  NODE_ENV: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

jobs:
  static-site-deploy:
    name: Static Site Deployment
    runs-on: ubuntu-latest
    if: hashFiles('index.html') != '' || hashFiles('_config.yml') != '' || hashFiles('*.html') != ''
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Pages
        if: hashFiles('_config.yml') != ''
        uses: actions/configure-pages@v4

      - name: Build static site
        run: |
          if [ -f "package.json" ]; then
            npm ci
            npm run build
          fi
          echo "Static site build completed"

      - name: Deploy to GitHub Pages
        id: deploy
        if: hashFiles('_config.yml') != ''
        uses: actions/deploy-pages@v4
        with:
          install_deps: false

      - name: Deploy to Netlify
        if: hashFiles('netlify.toml') != ''
        uses: nwtgck/actions-netlify@v2
        with:
          publish-dir: './dist'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions"
          enable-pull-request-comment: false
          enable-commit-comment: false
          overwrites-pull-request-comment: false
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Deploy to Vercel
        if: hashFiles('vercel.json') != ''
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          working-directory: ./

  nodejs-deploy:
    name: Node.js Application Deployment
    runs-on: ubuntu-latest
    if: hashFiles('package.json') != '' && hashFiles('server.js') != ''
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
      url: ${{ steps.deploy.outputs.url }}
    needs: [static-site-deploy]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install and build
        run: |
          npm ci
          npm run build || true

      - name: Deploy to Heroku
        id: deploy
        uses: akhileshns/heroku-deploy@v3.12.12
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: ${{ secrets.HEROKU_APP_NAME }}
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
          appdir: './'
          healthcheck: "https://${{ secrets.HEROKU_APP_NAME }}.herokuapp.com/health"

      - name: Deploy to Railway
        if: hashFiles('railway.json') != '' || hashFiles('railway.toml') != ''
        uses: railway-app/railway-action@v1
        with:
          api-token: ${{ secrets.RAILWAY_TOKEN }}
          service: ${{ secrets.RAILWAY_SERVICE_ID }}

      - name: Deploy to DigitalOcean App Platform
        if: hashFiles('.do/app.yaml') != ''
        uses: digitalocean/app_action@v1
        with:
          app_name: ${{ secrets.DO_APP_NAME }}
          token: ${{ secrets.DO_API_TOKEN }}

  python-deploy:
    name: Python Application Deployment
    runs-on: ubuntu-latest
    if: hashFiles('requirements.txt') != '' && (hashFiles('app.py') != '' || hashFiles('main.py') != '')
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
      url: ${{ steps.deploy.outputs.url }}
    needs: [nodejs-deploy]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Deploy to PythonAnywhere
        if: hashFiles('pythonanywhere.json') != ''
        uses: tisonkun/pythonanywhere-action@v1
        with:
          api-token: ${{ secrets.PYTHONANYWHERE_TOKEN }}
          domain: ${{ secrets.PYTHONANYWHERE_DOMAIN }}
          project-name: ${{ secrets.PYTHONANYWHERE_PROJECT }}
          requirements-file: requirements.txt

      - name: Deploy to AWS Elastic Beanstalk
        if: hashFiles('.elasticbeanstalk/') != ''
        uses: einaregilsson/beanstalk-deploy@v21
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name: ${{ secrets.EB_APP_NAME }}
          environment_name: ${{ secrets.EB_ENV_NAME }}
          region: ${{ secrets.AWS_REGION }}
          version_label: "v${{ github.sha }}"
          deployment_package: deploy.zip

      - name: Create deployment package
        run: |
          zip -r deploy.zip . -x ".git/*" ".github/*" "__pycache__/*" "*.pyc" "tests/*"

  docker-deploy:
    name: Docker Application Deployment
    runs-on: ubuntu-latest
    if: hashFiles('Dockerfile') != ''
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
      url: ${{ steps.deploy.outputs.url }}
    needs: [python-deploy]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKER_REPO_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64

      - name: Deploy to Kubernetes
        id: deploy
        if: hashFiles('k8s/') != ''
        uses: azure/k8s-deploy@v1
        with:
          manifests: |
            k8s/deployment.yaml
            k8s/service.yaml
          images: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKER_REPO_NAME }}:${{ github.sha }}
          kubeconfig: ${{ secrets.KUBE_CONFIG }}

      - name: Deploy to Docker Swarm
        if: hashFiles('docker-compose.yml') != ''
        run: |
          echo "${{ secrets.DOCKER_SWARM_SSH_KEY }}" > deploy_key
          chmod 600 deploy_key
          scp -o StrictHostKeyChecking=no -i deploy_key docker-compose.yml ${{ secrets.DOCKER_SWARM_USER }}@${{ secrets.DOCKER_SWARM_HOST }}:/tmp/
          ssh -o StrictHostKeyChecking=no -i deploy_key ${{ secrets.DOCKER_SWARM_USER }}@${{ secrets.DOCKER_SWARM_HOST }} "cd /tmp && docker-compose pull && docker-compose up -d"

  mobile-deploy:
    name: Mobile Application Deployment
    runs-on: ubuntu-latest
    if: hashFiles('expo.json') != '' || hashFiles('app.json') != ''
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
    needs: [docker-deploy]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Expo CLI
        run: npm install -g @expo/cli

      - name: Install dependencies
        run: npm ci

      - name: Build for Android
        if: github.event.inputs.environment == 'production'
        run: |
          eas build --platform android --profile production
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Build for iOS
        if: github.event.inputs.environment == 'production'
        run: |
          eas build --platform ios --profile production
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Deploy to Expo
        if: github.event.inputs.environment == 'staging'
        run: |
          eas build --platform all --profile preview
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  post-deployment:
    name: Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: [static-site-deploy, nodejs-deploy, python-deploy, docker-deploy, mobile-deploy]
    if: always()
    steps:
      - name: Wait for deployment
        run: |
          echo "Waiting for deployments to propagate..."
          sleep 30

      - name: Health check
        run: |
          echo "# Deployment Health Check" > health-check.md
          echo "" >> health-check.md
          echo "## Status Check" >> health-check.md
          echo "- Static Site: ${{ needs.static-site-deploy.result }}" >> health-check.md
          echo "- Node.js App: ${{ needs.nodejs-deploy.result }}" >> health-check.md
          echo "- Python App: ${{ needs.python-deploy.result }}" >> health-check.md
          echo "- Docker App: ${{ needs.docker-deploy.result }}" >> health-check.md
          echo "- Mobile App: ${{ needs.mobile-deploy.result }}" >> health-check.md
          echo "" >> health-check.md
          echo "## Deployment Time" >> health-check.md
          echo "Deployed at: $(date)" >> health-check.md

      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          # Add curl tests here when URLs are available
          echo "Smoke tests completed"

      - name: Notify team
        if: needs.static-site-deploy.result == 'success' || needs.nodejs-deploy.result == 'success' || needs.python-deploy.result == 'success'
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          text: |
            ðŸš€ Deployment completed!
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Environment: ${{ github.event.inputs.environment || 'production' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Create deployment badge
        if: success()
        run: |
          echo "![Deploy Status](https://img.shields.io/badge/deployment-successful-brightgreen)" > deployment-badge.md

      - name: Upload deployment report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: |
            health-check.md
            deployment-badge.md